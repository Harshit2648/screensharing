<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simple Screen Sharing App</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  min-height:100vh;padding:20px;
}
.container{
  max-width:1400px;margin:0 auto;background:#fff;border-radius:16px;
  padding:28px;box-shadow:0 20px 40px rgba(0,0,0,.12);
}
h1{text-align:center;color:#333;margin-bottom:22px;font-size:2.4rem}
.status{
  text-align:center;margin-bottom:16px;padding:12px;border-radius:10px;font-weight:700
}
.status.connected{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
.status.disconnected{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
.controls{display:flex;gap:14px;justify-content:center;margin-bottom:18px;flex-wrap:wrap}
button{
  padding:12px 22px;border:none;border-radius:10px;font-size:16px;font-weight:700;
  cursor:pointer;transition:.25s;
}
.btn-primary{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.18)}
.btn-danger{background:linear-gradient(45deg,#ff6b6b,#ee5a52);color:#fff}
.btn-danger:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.18)}
.btn-secondary{background:linear-gradient(45deg,#6c757d,#5a6268);color:#fff}
.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.18)}
.btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important}

.users-panel{background:#f8f9fa;padding:16px;border-radius:12px;margin-bottom:18px}
.users-panel h3{color:#333;margin-bottom:10px}
.user-item{
  display:flex;justify-content:space-between;align-items:center;padding:10px 12px;
  margin-bottom:8px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)
}
.user-info{display:flex;align-items:center;gap:10px}
.status-indicator{width:12px;height:12px;border-radius:50%;background:#28a745}
.sharing-indicator{background:#dc3545;animation:pulse 1.5s ease-in-out infinite alternate}
@keyframes pulse{from{opacity:1}to{opacity:.5}}

.info-box{
  background:#e7f3ff;border:1px solid #b3d7ff;border-radius:10px;padding:16px;margin-bottom:16px
}
.info-box h3{color:#0066cc;margin-bottom:6px}
.info-box ul{margin-left:20px;color:#333}
.info-box li{margin-bottom:4px}

/* ---- BIG screen layout ---- */
.screen-container {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 12px;
  justify-content: center;
}

.screen-wrapper {
  background: #111;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 12px 28px rgba(0,0,0,0.35);
  border: 3px solid #222;
  width: 100%;
  max-width: 900px;
}

.screen-wrapper h4 {
  position: absolute;
  top: 10px;
  left: 12px;
  color: #fff;
  background: rgba(0,0,0,0.6);
  padding: 6px 10px;
  border-radius: 8px;
  z-index: 2;
  font-weight: 600;
}

.screen-video {
  width: 100%;
  height: auto;
  min-height: 500px;
  background: #000;
  object-fit: contain;
}

.screen-controls {
  position: absolute;
  top: 10px;
  right: 12px;
  display: flex;
  gap: 8px;
  z-index: 3;
}

.icon-btn {
  background: rgba(0,0,0,0.7);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 14px;
}
.icon-btn:hover { filter: brightness(1.15); }

/* ---- Viewer Permission Modal ---- */
.modal{
  display:none;position:fixed;z-index:999;inset:0;
  background:rgba(0,0,0,.55);justify-content:center;align-items:center;padding:16px
}
.modal-content{
  background:#fff;max-width:420px;width:100%;border-radius:14px;padding:20px 18px;text-align:center;
  box-shadow:0 10px 26px rgba(0,0,0,.25)
}
.modal-content h2{margin-bottom:8px}
.modal-content p{margin-bottom:16px;color:#444}
.modal-buttons{display:flex;gap:12px;justify-content:center}
.modal-buttons button{flex:1}
</style>
</head>
<body>
  <div class="container">
    <h1>üñ•Ô∏è Simple Screen Sharing</h1>

    <div id="status" class="status disconnected">Connecting to server...</div>

    <div class="info-box">
      <h3>How to use</h3>
      <ul>
        <li>Click <b>Start Sharing</b> to share your screen.</li>
        <li>When someone starts sharing, you‚Äôll get a popup to <b>Accept/Decline</b>.</li>
        <li>Open in two tabs/windows (or two devices) to test.</li>
      </ul>
    </div>

    <div class="controls">
      <button id="startBtn" class="btn-primary">Start Sharing My Screen</button>
      <button id="stopBtn" class="btn-danger" disabled>Stop Sharing</button>
    </div>

    <div class="users-panel">
      <h3>Connected Users (<span id="userCount">0</span>)</h3>
      <div id="usersList"></div>
    </div>

    <div id="screenContainer" class="screen-container"></div>
  </div>

  <!-- Viewer Permission Modal -->
  <div id="viewerModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2>View screen?</h2>
      <p id="viewerText">A user started sharing. Do you want to view?</p>
      <div class="modal-buttons">
        <button id="viewerAccept" class="btn-primary">Accept</button>
        <button id="viewerDecline" class="btn-danger">Decline</button>
      </div>
    </div>
  </div>
 <!-- hello -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
  const socket = io();

  const statusEl = document.getElementById('status');
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const usersListEl = document.getElementById('usersList');
  const userCountEl = document.getElementById('userCount');
  const screenContainer = document.getElementById('screenContainer');

  const viewerModal = document.getElementById('viewerModal');
  const viewerText  = document.getElementById('viewerText');
  const viewerAccept= document.getElementById('viewerAccept');
  const viewerDecline= document.getElementById('viewerDecline');
  let pendingSharerId = null;

  let localStream = null;
  let peerConnections = new Map();
  let connectedUsers = [];

  const rtcConfig = {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      { urls: 'stun:stun.stunprotocol.org:3478' }
    ]
  };

  socket.on('connect', () => updateStatus('Connected to server', true));
  socket.on('disconnect', () => updateStatus('Disconnected from server', false));

  socket.on('users-update', (users) => {
    connectedUsers = users;
    updateUsersList(users);
  });

  socket.on('user-started-sharing', (userId) => {
    if (userId === socket.id) return;
    pendingSharerId = userId;
    viewerText.textContent = `User ${userId.substring(0,8)} started sharing. View their screen?`;
    openViewerModal();
  });

  socket.on('user-stopped-sharing', (userId) => {
    removeVideo(userId);
    closePeerConnection(userId);
    if (pendingSharerId === userId) {
      closeViewerModal();
      pendingSharerId = null;
    }
  });

  socket.on('user-disconnected', (userId) => {
    removeVideo(userId);
    closePeerConnection(userId);
    if (pendingSharerId === userId) {
      closeViewerModal();
      pendingSharerId = null;
    }
  });

  socket.on('offer', async (data) => { await handleOffer(data.offer, data.sender); });
  socket.on('answer', async (data) => { await handleAnswer(data.answer, data.sender); });
  socket.on('ice-candidate', async (data) => { await handleIceCandidate(data.candidate, data.sender); });

  startBtn.addEventListener('click', startScreenShare);
  stopBtn.addEventListener('click', stopScreenShare);

  viewerAccept.addEventListener('click', async () => {
    const userId = pendingSharerId;
    closeViewerModal();
    if (userId) viewUserScreen(userId);
    pendingSharerId = null;
  });

  viewerDecline.addEventListener('click', () => {
    closeViewerModal();
    pendingSharerId = null;
  });

  function updateStatus(msg, ok){
    statusEl.textContent = msg;
    statusEl.className = ok ? 'status connected' : 'status disconnected';
  }

  function updateUsersList(users){
    userCountEl.textContent = users.length;
    usersListEl.innerHTML = '';
    users.forEach(u => {
      if (u.id === socket.id) return;
      const row = document.createElement('div');
      row.className = 'user-item';
      row.innerHTML = `
        <div class="user-info">
          <div class="status-indicator ${u.isSharing ? 'sharing-indicator':''}"></div>
          <span>User ${u.id.substring(0,8)} ${u.isSharing ? '(Sharing)':''}</span>
        </div>
        ${u.isSharing ? `<button class="btn-secondary" data-view="${u.id}">View Screen</button>`:''}
      `;
      usersListEl.appendChild(row);
    });
    usersListEl.querySelectorAll('[data-view]').forEach(btn=>{
      btn.onclick = () => viewUserScreen(btn.getAttribute('data-view'));
    });
  }

  async function startScreenShare(){
    try{
      localStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true,controls:false });
      startBtn.disabled = true; stopBtn.disabled = false;
      socket.emit('start-sharing');

      const vTrack = localStream.getVideoTracks()[0];
      vTrack.addEventListener('ended', () => stopScreenShare());
    }catch(err){
      console.error('startScreenShare error:', err);
      alert('Could not start screen sharing. Please allow permissions.');
    }
  }

  function stopScreenShare(){
    if (localStream){
      localStream.getTracks().forEach(t=>t.stop());
      localStream = null;
    }
    peerConnections.forEach((pc)=> pc.close());
    peerConnections.clear();

    startBtn.disabled = false; stopBtn.disabled = true;
    socket.emit('stop-sharing');
  }

  async function viewUserScreen(userId){
    try{
      if (peerConnections.has(userId)) return;

      const pc = new RTCPeerConnection(rtcConfig);
      peerConnections.set(userId, pc);

      pc.onconnectionstatechange = () => {
        if (['failed','disconnected','closed'].includes(pc.connectionState)){
          removeVideo(userId); closePeerConnection(userId);
        }
      };

      pc.ontrack = (ev) => {
        if (ev.streams && ev.streams[0]) addVideoElement(userId, ev.streams[0]);
      };

      pc.onicecandidate = (ev) => {
        if (ev.candidate){
          socket.emit('ice-candidate', { target:userId, candidate:ev.candidate });
        }
      };

      const offer = await pc.createOffer({ offerToReceiveVideo:true, offerToReceiveAudio:true });
      await pc.setLocalDescription(offer);
      socket.emit('offer', { target:userId, offer });
    }catch(err){
      console.error('viewUserScreen error:', err);
      alert('Could not view screen: ' + err.message);
    }
  }

  async function handleOffer(offer, senderId){
    try{
      if (!peerConnections.has(senderId)){
        const pc = new RTCPeerConnection(rtcConfig);
        peerConnections.set(senderId, pc);

        pc.onconnectionstatechange = () => {
          if (['failed','disconnected','closed'].includes(pc.connectionState)){
            removeVideo(senderId); closePeerConnection(senderId);
          }
        };

        pc.onicecandidate = (ev) => {
          if (ev.candidate){
            socket.emit('ice-candidate', { target:senderId, candidate:ev.candidate });
          }
        };

        if (localStream){
          localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        }

        pc.ontrack = (ev) => {
          if (ev.streams && ev.streams[0]) addVideoElement(senderId, ev.streams[0]);
        };
      }

      const pc = peerConnections.get(senderId);
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit('answer', { target:senderId, answer });
    }catch(err){ console.error('handleOffer error:', err); }
  }

  async function handleAnswer(answer, senderId){
    try{
      const pc = peerConnections.get(senderId);
      if (pc) await pc.setRemoteDescription(answer);
    }catch(err){ console.error('handleAnswer error:', err); }
  }

  async function handleIceCandidate(candidate, senderId){
    try{
      const pc = peerConnections.get(senderId);
      if (pc) await pc.addIceCandidate(candidate);
    }catch(err){ console.error('handleIceCandidate error:', err); }
  }

  function addVideoElement(userId, stream){
    removeVideo(userId);
    const wrap = document.createElement('div');
    wrap.className = 'screen-wrapper';
    wrap.id = `video-${userId}`;

    const title = document.createElement('h4');
    title.textContent = `User ${userId.substring(0,8)}'s Screen`;

    const controls = document.createElement('div');
    controls.className = 'screen-controls';

    const closeBtn = document.createElement('button');
    closeBtn.className = 'icon-btn';
    closeBtn.textContent = 'Close';
    closeBtn.onclick = () => { removeVideo(userId); closePeerConnection(userId); };

    const fsBtn = document.createElement('button');
    fsBtn.className = 'icon-btn';
    fsBtn.textContent = 'Fullscreen';
    fsBtn.onclick = () => {
      const vid = wrap.querySelector('video');
      if (vid.requestFullscreen) vid.requestFullscreen();
    };

    controls.appendChild(fsBtn);
    controls.appendChild(closeBtn);

    const video = document.createElement('video');
    video.autoplay = true; video.playsinline = true; video.muted = true;
    video.srcObject = stream;
    video.className = 'screen-video';

    wrap.appendChild(title);
    wrap.appendChild(controls);
    wrap.appendChild(video);
    screenContainer.appendChild(wrap);

    video.play().catch(()=>{});
  }

  function removeVideo(userId){
    const el = document.getElementById(`video-${userId}`);
    if (el) el.remove();
  }

  function closePeerConnection(userId){
    const pc = peerConnections.get(userId);
    if (pc){ pc.close(); peerConnections.delete(userId); }
  }

  function openViewerModal(){ viewerModal.style.display = 'flex'; viewerModal.setAttribute('aria-hidden','false'); }
  function closeViewerModal(){ viewerModal.style.display = 'none'; viewerModal.setAttribute('aria-hidden','true'); }
  </script>
</body>
</html>
